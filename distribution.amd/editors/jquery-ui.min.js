define(["jquery","underscore","backbone","backbone-forms"],function(e,t,n){(function(){var r=n.Form,i=r.editors.Base,s=r.helpers.createTemplate,o=r.helpers.triggerCancellableEvent,u={};u["jqueryui.Date"]=i.extend({className:"bbf-jui-date",initialize:function(e){i.prototype.initialize.call(this,e),this.value&&!t.isDate(this.value)&&(this.value=new Date(this.value));if(!this.value){var n=new Date;n.setSeconds(0),n.setMilliseconds(0),this.value=n}},render:function(){var t=this.$el;t.html("<input>");var n=e("input",t);return n.datepicker({dateFormat:"dd/mm/yy",showButtonPanel:!0}),this._observeDatepickerEvents(),u["jqueryui.Date"].prototype.setValue.call(this,this.value),this},getValue:function(){var t=e("input",this.el),n=t.datepicker("getDate");return n},setValue:function(t){e("input",this.el).datepicker("setDate",t)},focus:function(){if(this.hasFocus)return;this.$("input").datepicker("show")},blur:function(){if(!this.hasFocus)return;this.$("input").datepicker("hide")},_observeDatepickerEvents:function(){var e=this;this.$("input").datepicker("option","onSelect",function(){e.trigger("change",e)}),this.$("input").datepicker("option","onClose",function(){if(!e.hasFocus)return;e.trigger("blur",e)}),this.$("input").datepicker("option","beforeShow",function(){return e.hasFocus?{}:(e.trigger("focus",e),{})})}}),u["jqueryui.DateTime"]=u["jqueryui.Date"].extend({className:"bbf-jui-datetime",template:s("<select>{{hours}}</select> : <select>{{mins}}</select>"),render:function(){function n(e){return e<10?"0"+e:e}u["jqueryui.Date"].prototype.render.call(this);var r=t.range(0,24),i=[];t.each(r,function(e){i.push('<option value="'+e+'">'+n(e)+"</option>")});var s=this.schema.minsInterval||15,o=t.range(0,60,s),a=[];return t.each(o,function(e){a.push('<option value="'+e+'">'+n(e)+"</option>")}),this.$el.append(this.template({hours:i.join(),mins:a.join()})),this._observeDatepickerEvents(),this.$hours=e("select:eq(0)",this.el),this.$mins=e("select:eq(1)",this.el),this.setValue(this.value),this},getValue:function(){var t=e("input",this.el),n=t.datepicker("getDate");return n.setHours(this.$hours.val()),n.setMinutes(this.$mins.val()),n.setMilliseconds(0),n},setValue:function(e){u["jqueryui.Date"].prototype.setValue.call(this,e),this.$hours.val(e.getHours()),this.$mins.val(e.getMinutes())}}),u["jqueryui.List"]=i.extend({className:"bbf-jui-list",template:s('      <ul></ul>      <div><button class="bbf-list-add">Add</div>    '),itemTemplate:s('      <li rel="{{id}}">        <span class="bbf-list-text">{{text}}</span>        <div class="bbf-list-actions">          <button class="bbf-list-edit">Edit</button>          <button class="bbf-list-del">Delete</button>        </div>      </li>    '),editorTemplate:s('      <div class="bbf-field">          <div class="bbf-list-editor"></div>      </div>    '),events:{"click .bbf-list-add":"addNewItem","click .bbf-list-edit":"editItem","click .bbf-list-del":"deleteItem"},initialize:function(e){i.prototype.initialize.call(this,e);if(!this.schema)throw"Missing required option 'schema'";this.schema.listType=this.schema.listType||"Text";if(this.schema.listType==="NestedModel"&&!this.schema.model)throw"Missing required option 'schema.model'"},render:function(){var n=this.$el;n.html(this.template());var r=this,i=this.value||[],s=this.schema,o=this.itemToString,u=this.itemTemplate,a=e("ul",n);return t.each(i,function(t){var n=o.call(r,t),i=e(u({id:t.id||"",text:n}));e.data(i[0],"data",t),a.append(i)}),s.sortable!==!1&&(a.sortable({axis:"y",cursor:"move",containment:"parent"}),n.addClass("bbf-list-sortable")),e("button.bbf-list-add",n).button({text:!1,icons:{primary:"ui-icon-plus"}}),e("button.bbf-list-edit",n).button({text:!1,icons:{primary:"ui-icon-pencil"}}),e("button.bbf-list-del",n).button({text:!1,icons:{primary:"ui-icon-trash"}}),this.hasFocus&&this.trigger("blur",this),this},itemToString:function(e){if(!e)return e;var t=this.schema;if(t.itemToString)return t.itemToString(e);if(this.schema.listType==="NestedModel"){var n=new this.schema.model(e);return n.toString()}return e},addNewItem:function(t){t&&t.preventDefault();var n=this;this.openEditor(null,function(t,r){o(n,"addItem",[t,r],function(){var i=n.itemToString(t),s=e(n.itemTemplate({id:t.id||"",text:i}));e.data(s[0],"data",t),e("ul",n.el).append(s),e("button.bbf-list-edit",this.el).button({text:!1,icons:{primary:"ui-icon-pencil"}}),e("button.bbf-list-del",this.el).button({text:!1,icons:{primary:"ui-icon-trash"}}),n.trigger("add",n,t),n.trigger("item:change",n,r),n.trigger("change",n)})})},editItem:function(t){t.preventDefault();var n=this,r=e(t.target).closest("li"),i=e.data(r[0],"data");this.openEditor(i,function(t,i){o(n,"editItem",[t,i],function(){e(".bbf-list-text",r).html(n.itemToString(t)),e.data(r[0],"data",t),n.trigger("item:change",n,i),n.trigger("change",n)})})},deleteItem:function(t){function a(){o(n,"removeItem",[i],function(){r.remove(),n.trigger("remove",n,i),n.trigger("change",n)})}t.preventDefault();var n=this,r=e(t.target).closest("li"),i=e.data(r[0],"data"),s=this.schema.confirmDelete?this.schema.confirmDelete:!1,u=this.schema.confirmDeleteMsg||"Are you sure?";this.schema.confirmDelete?confirm(u)&&a():a()},openEditor:function(t,n){var i=this,s=this.schema,o=s.listType||"Text",u=r.helpers.createEditor(o,{key:"",schema:s,value:t}).render(),a=this.editorContainer=e(this.editorTemplate());e(".bbf-list-editor",a).html(u.el);var f=function(){var e=u.validate();if(e)return;n(u.getValue(),u),a.dialog("close")},l=function(e){if(e.keyCode!==13)return;f()};e(a).dialog({resizable:!1,modal:!0,width:500,title:t?"Edit item":"New item",buttons:{OK:f,Cancel:function(){a.dialog("close")}},close:function(){i.editorContainer=null,e(document).unbind("keydown",l),u.remove(),a.remove(),i.trigger("item:close",i,u),i.trigger("item:blur",i,u),i.trigger("blur",i)}}),this.trigger("item:open",this,u),this.trigger("item:focus",this,u),this.trigger("focus",this),e(document).bind("keydown",l)},getValue:function(){var t=[];return e("li",this.el).each(function(n,r){t.push(e.data(r,"data"))}),t},setValue:function(e){this.value=e,this.render()},focus:function(){if(this.hasFocus)return;var e=this.$("li .bbf-list-edit").first();e.length>0?e.click():this.addNewItem()},blur:function(){if(!this.hasFocus)return;this.editorContainer&&this.editorContainer.dialog("close")}}),t.extend(r.editors,u)})()})