define(["jquery","underscore","backbone","backbone-forms"],function(e,t,n){(function(){var r=n.Form,i=r.editors;i.List=i.Base.extend({events:{'click [data-action="add"]':function(e){e.preventDefault(),this.addItem(null,!0)}},initialize:function(e){i.Base.prototype.initialize.call(this,e);var n=this.schema;if(!n)throw"Missing required option 'schema'";this.schema=t.extend({listTemplate:"list",listItemTemplate:"listItem"},n),this.Editor=function(){var e=n.itemType;return e?i.List[e]?i.List[e]:i[e]:i.Text}(),this.items=[]},render:function(){var n=this,i=this.value||[],s=e(r.templates[this.schema.listTemplate]({items:'<b class="bbf-tmp"></b>'}));return this.$list=s.find(".bbf-tmp").parent().empty(),i.length?t.each(i,function(e){n.addItem(e)}):this.Editor.isAsync||this.addItem(),this.setElement(s),this.$el.attr("id",this.id),this.$el.attr("name",this.key),this.hasFocus&&this.trigger("blur",this),this},addItem:function(e,n){var r=this,s=(new i.List.Item({list:this,schema:this.schema,value:e,Editor:this.Editor,key:this.key})).render(),o=function(){r.items.push(s),r.$list.append(s.el),s.editor.on("all",function(e){if(e=="change")return;args=t.toArray(arguments),args[0]="item:"+e,args.splice(1,0,r),i.List.prototype.trigger.apply(this,args)},r),s.editor.on("change",function(){s.addEventTriggered||(s.addEventTriggered=!0,this.trigger("add",this,s.editor)),this.trigger("item:change",this,s.editor),this.trigger("change",this)},r),s.editor.on("focus",function(){if(this.hasFocus)return;this.trigger("focus",this)},r),s.editor.on("blur",function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(t.find(e.items,function(e){return e.editor.hasFocus}))return;e.trigger("blur",e)},0)},r);if(n||e)s.addEventTriggered=!0;n&&(r.trigger("add",r,s.editor),r.trigger("change",r))};return this.Editor.isAsync?s.editor.on("readyToAdd",o,this):o(),s},removeItem:function(e){var n=this.schema.confirmDelete;if(n&&!confirm(n))return;var r=t.indexOf(this.items,e);this.items[r].remove(),this.items.splice(r,1),e.addEventTriggered&&(this.trigger("remove",this,e.editor),this.trigger("change",this)),!this.items.length&&!this.Editor.isAsync&&this.addItem()},getValue:function(){var e=t.map(this.items,function(e){return e.getValue()});return t.without(e,undefined,"")},setValue:function(e){this.value=e,this.render()},focus:function(){if(this.hasFocus)return;this.items[0]&&this.items[0].editor.focus()},blur:function(){if(!this.hasFocus)return;focusedItem=t.find(this.items,function(e){return e.editor.hasFocus}),focusedItem&&focusedItem.editor.blur()},remove:function(){t.invoke(this.items,"remove"),i.Base.prototype.remove.call(this)},validate:function(){if(!this.validators)return null;var e=t.map(this.items,function(e){return e.validate()}),n=t.compact(e).length?!0:!1;if(!n)return null;var r={type:"list",message:"Some of the items in the list failed validation",errors:e};return r}}),i.List.Item=n.View.extend({events:{'click [data-action="remove"]':function(e){e.preventDefault(),this.list.removeItem(this)},"keydown input[type=text]":function(e){if(e.keyCode!=13)return;e.preventDefault(),this.list.addItem(),this.list.$list.find("> li:last input").focus()}},initialize:function(e){this.list=e.list,this.schema=e.schema||this.list.schema,this.value=e.value,this.Editor=e.Editor||i.Text,this.key=e.key},render:function(){this.editor=(new this.Editor({key:this.key,schema:this.schema,value:this.value,list:this.list,item:this})).render();var t=e(r.templates[this.schema.listItemTemplate]({editor:'<b class="bbf-tmp"></b>'}));return t.find(".bbf-tmp").replaceWith(this.editor.el),this.setElement(t),this},getValue:function(){return this.editor.getValue()},setValue:function(e){this.editor.setValue(e)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove(),n.View.prototype.remove.call(this)},validate:function(){var e=this.getValue(),n=this.list.form?this.list.form.getValue():{},i=this.schema.validators,s=r.helpers.getValidator;if(!i)return null;var o=null;return t.every(i,function(t){return o=s(t)(e,n),continueLoop=o?!1:!0}),o?this.setError(o):this.clearError(),o?o:null},setError:function(e){this.$el.addClass(r.classNames.error),this.$el.attr("title",e.message)},clearError:function(){this.$el.removeClass(r.classNames.error),this.$el.attr("title",null)}}),i.List.Modal=i.List.Object=i.List.NestedModel=i.Base.extend({events:{click:"openEditor"},initialize:function(e){i.Base.prototype.initialize.call(this,e);var n=this.schema;if(!i.List.Modal.ModalAdapter)throw"A ModalAdapter is required";if(n.itemType=="Object"){if(!n.subSchema)throw'Missing required option "schema.subSchema"';this.nestedSchema=n.subSchema}if(n.itemType=="NestedModel"){if(!n.model)throw'Missing required option "schema.model"';this.nestedSchema=n.model.prototype.schema,t.isFunction(this.nestedSchema)&&(this.nestedSchema=this.nestedSchema())}},render:function(){var e=this;return t.isEmpty(this.value)?this.openEditor():(this.renderSummary(),setTimeout(function(){e.trigger("readyToAdd")},0)),this.hasFocus&&this.trigger("blur",this),this},renderSummary:function(){var e=r.templates["list.Modal"];this.$el.html(e({summary:this.getStringValue()}))},itemToString:function(e){e=e||{};var n=[];return t.each(this.nestedSchema,function(i,s){var o=i.title?i.title:r.helpers.keyToTitle(s),u=e[s];if(t.isUndefined(u)||t.isNull(u))u="";n.push(o+": "+u)}),n.join("<br />")},getStringValue:function(){var e=this.schema,n=this.getValue();return t.isEmpty(n)?"[Empty]":e.itemToString?e.itemToString(n):e.itemType=="NestedModel"?(new e.model(n)).toString():this.itemToString(n)},openEditor:function(){var e=this,i=new r({schema:this.nestedSchema,data:this.value}),s=this.modal=(new n.BootstrapModal({content:i,animate:!0})).open();this.trigger("open",this),this.trigger("focus",this),s.on("cancel",function(){this.modal=null,this.trigger("close",this),this.trigger("blur",this)},this),s.on("ok",t.bind(this.onModalSubmitted,this,i,s))},onModalSubmitted:function(e,t){var n=!this.value,r=e.validate();if(r)return t.preventClose();this.modal=null,this.value=e.getValue(),this.renderSummary(),n&&this.trigger("readyToAdd"),this.trigger("change",this),this.trigger("close",this),this.trigger("blur",this)},getValue:function(){return this.value},setValue:function(e){this.value=e},focus:function(){if(this.hasFocus)return;this.openEditor()},blur:function(){if(!this.hasFocus)return;this.modal&&(this.modal.trigger("cancel"),this.modal.close())}},{ModalAdapter:n.BootstrapModal,isAsync:!0})})()})