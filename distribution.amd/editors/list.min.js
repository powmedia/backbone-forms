define(["jquery","underscore","backbone"],function($,_,Backbone){(function(){var Form=Backbone.Form,editors=Form.editors;editors.List=editors.Base.extend({events:{'click [data-action="add"]':function(event){event.preventDefault(),this.addItem()}},initialize:function(options){editors.Base.prototype.initialize.call(this,options);var schema=this.schema;if(!schema)throw"Missing required option 'schema'";this.schema=_.extend({listTemplate:"list"},schema),this.Editor=function(){var type=schema.itemType;return type?editors.List[type]?editors.List[type]:editors[type]:editors.Text}(),this.items=[]},render:function(){var self=this,value=this.value||[],$el=$(Form.templates[this.schema.listTemplate]({items:'<b class="bbf-tmp"></b>'}));return this.$list=$el.find(".bbf-tmp").parent().empty(),value.length?_.each(value,function(itemValue){self.addItem(itemValue)}):this.Editor.isAsync||this.addItem(),this.setElement($el),this.$el.attr("id",this.id),this.$el.attr("name",this.key),this},addItem:function(value){var self=this,item=(new editors.List.Item({list:this,schema:this.schema,value:value,Editor:this.Editor,key:this.key})).render();this.Editor.isAsync?item.editor.on("readyToAdd",function(){self.items.push(item),self.$list.append(item.el)}):(this.items.push(item),this.$list.append(item.el))},removeItem:function(item){var confirmMsg=this.schema.confirmDelete;if(confirmMsg&&!confirm(confirmMsg))return;var index=_.indexOf(this.items,item);this.items[index].remove(),this.items.splice(index,1),!this.items.length&&!this.Editor.isAsync&&this.addItem()},getValue:function(){var values=_.map(this.items,function(item){return item.getValue()});return _.without(values,undefined,"")},setValue:function(value){this.value=value,this.render()},remove:function(){_.invoke(this.items,"remove"),editors.Base.prototype.remove.call(this)},validate:function(){if(!this.validators)return null;var errors=_.map(this.items,function(item){return item.validate()}),hasErrors=_.compact(errors).length?!0:!1;if(!hasErrors)return null;var fieldError={type:"list",message:"Some of the items in the list failed validation",errors:errors};return fieldError}}),editors.List.Item=Backbone.View.extend({events:{'click [data-action="remove"]':function(event){event.preventDefault(),this.list.removeItem(this)},"keydown input[type=text]":function(event){if(event.keyCode!=13)return;event.preventDefault(),this.list.addItem(),this.list.$list.find("> li:last input").focus()}},initialize:function(options){this.list=options.list,this.schema=options.schema||this.list.schema,this.value=options.value,this.Editor=options.Editor||editors.Text,this.key=options.key},render:function(){this.editor=(new this.Editor({key:this.key,schema:this.schema,value:this.value,list:this.list,item:this})).render();var $el=$(Form.templates.listItem({editor:'<b class="bbf-tmp"></b>'}));return $el.find(".bbf-tmp").replaceWith(this.editor.el),this.setElement($el),this},getValue:function(){return this.editor.getValue()},setValue:function(value){this.editor.setValue(value)},remove:function(){this.editor.remove(),Backbone.View.prototype.remove.call(this)},validate:function(){var value=this.getValue(),formValues=this.list.form?this.list.form.getValue():{},validators=this.schema.validators,getValidator=Form.helpers.getValidator;if(!validators)return null;var error=null;return _.every(validators,function(validator){return error=getValidator(validator)(value,formValues),continueLoop=error?!1:!0}),error?this.setError(error):this.clearError(),error?error:null},setError:function(err){this.$el.addClass(Form.classNames.error),this.$el.attr("title",err.message)},clearError:function(){this.$el.removeClass(Form.classNames.error),this.$el.attr("title",null)}}),editors.List.Modal=editors.List.Object=editors.List.NestedModel=editors.Base.extend({events:{click:"openEditor"},initialize:function(options){editors.Base.prototype.initialize.call(this,options);var schema=this.schema;if(!editors.List.Modal.ModalAdapter)throw"A ModalAdapter is required";if(schema.itemType=="Object"){if(!schema.subSchema)throw'Missing required option "schema.subSchema"';this.nestedSchema=schema.subSchema}if(schema.itemType=="NestedModel"){if(!schema.model)throw'Missing required option "schema.model"';this.nestedSchema=schema.model.prototype.schema,_.isFunction(this.nestedSchema)&&(this.nestedSchema=this.nestedSchema())}},render:function(){var self=this;return _.isEmpty(this.value)?this.openEditor():(this.renderSummary(),setTimeout(function(){self.trigger("readyToAdd")},0)),this},renderSummary:function(){var template=Form.templates["list.Modal"];this.$el.html(template({summary:this.getStringValue()}))},itemToString:function(value){value=value||{};var parts=[];return _.each(this.nestedSchema,function(schema,key){var desc=schema.title?schema.title:Form.helpers.keyToTitle(key),val=value[key];if(_.isUndefined(val)||_.isNull(val))val="";parts.push(desc+": "+val)}),parts.join("<br />")},getStringValue:function(){var schema=this.schema,value=this.getValue();return _.isEmpty(value)?"[Empty]":schema.itemToString?schema.itemToString(value):schema.itemType=="NestedModel"?(new schema.model(value)).toString():this.itemToString(value)},openEditor:function(){var self=this,form=new Form({schema:this.nestedSchema,data:this.value}),modal=(new Backbone.BootstrapModal({content:form,animate:!0})).open();modal.on("ok",_.bind(this.onModalSubmitted,this,form,modal))},onModalSubmitted:function(form,modal){var isNew=_.isEmpty(this.value),error=form.validate();if(error)return modal.preventClose();this.value=form.getValue(),this.renderSummary(),isNew&&this.trigger("readyToAdd")},getValue:function(){return this.value},setValue:function(value){this.value=value}},{ModalAdapter:Backbone.BootstrapModal,isAsync:!0})})()})