define("backbone-forms",["jquery","Backbone"],function(){var a=function(){return Backbone.View.extend({fields:null,initialize:function(a){this.schema=function(){if(a.schema)return a.schema;var b=a.model;if(!b)throw new Error("Could not find schema");return _.isFunction(b.schema)?b.schema():b.schema}(),this.model=a.model,this.data=a.data,this.fieldsToRender=a.fields||_.keys(this.schema),this.fieldsets=a.fieldsets,this.templateName=a.template||"form",this.fields={}},render:function(){var b=this,c=this.fieldsets,d=a.templates,e=$(d[this.templateName]({fieldsets:'<div class="bbf-placeholder"></div>'})),f=$(".bbf-placeholder",e);return c||(c=[{fields:this.fieldsToRender}]),_.each(c,function(a){_(a).isArray()&&(a={fields:a});var c=$(d.fieldset(_.extend({},a,{legend:a.legend?"<legend>"+a.legend+"</legend>":"",fields:'<div class="bbf-placeholder"></div>'}))),e=$(".bbf-placeholder",c);b.renderFields(a.fields,e),e=e.children().unwrap(),f.append(c)}),f.children().unwrap(),this.setElement(e),this},renderFields:function(b,c){var d=this,e=this.schema,f=this.model,g=this.data,h=this.fields,i=a.helpers.getNested;_.each(b,function(b){var j=function(){if(e[b])return e[b];var a=b.replace(/\./g,".subSchema.");return i(e,a)}();if(!j)throw"Field '"+b+"' not found in schema";var k={form:d,key:b,schema:j,idPrefix:d.options.idPrefix};f?k.model=f:g?k.value=g[b]:k.value=null;var l=new a.Field(k);j.type=="Hidden"?l.editor=a.helpers.createEditor("Hidden",k):c.append(l.render().el),h[b]=l})},validate:function(){var a=this,b=this.fields,c=this.model,d={};_.each(b,function(a){var b=a.validate();b&&(d[a.key]=b)});if(c&&c.validate){var e=c.validate(this.getValue());if(e){var f=_.isObject(e)&&!_.isArray(e);f||(d._others=d._others||[],d._others.push(e)),f&&_.each(e,function(b,c){if(a.fields[c]&&!d[c])a.fields[c].setError(b);else{d._others=d._others||[];var e={};e[c]=b,d._others.push(e)}})}}return _.isEmpty(d)?null:d},commit:function(){var a=this.validate();if(a)return a;var b;this.model.set(this.getValue(),{error:function(a,c){b=c}});if(b)return b},getValue:function(a){if(a)return this.fields[a].getValue();var b={};return _.each(this.fields,function(a){b[a.key]=a.getValue()}),b},setValue:function(a){for(var b in a)this.fields[b].setValue(a[b])},remove:function(){var a=this.fields;for(var b in a)a[b].remove();Backbone.View.prototype.remove.call(this)}})}(),b={form:'      <form class="bbf-form">{{fieldsets}}</form>    ',fieldset:"      <fieldset>        {{legend}}        <ul>{{fields}}</ul>      </fieldset>    ",field:'    <li class="bbf-field bbf-field{{type}}">      <label for="{{id}}">{{title}}</label>      <div class="bbf-editor bbf-editor{{type}}">{{editor}}</div>      <div class="bbf-help">{{help}}</div>    </li>    '},c={error:"bbf-error"};return a.helpers=function(){var b={};return b.getNested=function(a,b){var c=b.split("."),d=a;for(var e=0,f=c.length;e<f;e++)d=d[c[e]];return d},b.keyToTitle=function(a){return a=a.replace(/([A-Z])/g," $1"),a=a.replace(/^./,function(a){return a.toUpperCase()}),a},b.compileTemplate=function(a){var b=_.templateSettings.interpolate;_.templateSettings.interpolate=/\{\{(.+?)\}\}/g;var c=_.template(a);return _.templateSettings.interpolate=b,c},b.createTemplate=function(a,c){var d=b.compileTemplate(a);return c?d(c):d},b.setTemplateCompiler=function(a){b.compileTemplate=a},b.setTemplates=function(c,d){var e=b.createTemplate;a.templates=a.templates||{},a.classNames=a.classNames||{},_.each(c,function(b,c,d){_.isString(b)&&(b=e(b)),a.templates[c]=b}),_.extend(a.classNames,d)},b.createEditor=function(b,c){var d;return _.isString(b)?d=a.editors[b]:d=b,new d(c)},b.triggerCancellableEvent=function(a,b,c,d){if(!a._callbacks||!a._callbacks[b])return d();var e=a._callbacks[b].next;if(!e)return d();var f=e.callback,g=e.context||this;c.push(d),f.apply(g,c)},b.getValidator=function(b){var c=a.validators;if(_.isRegExp(b))return c.regexp({regexp:b});if(_.isString(b)){if(!c[b])throw new Error('Validator "'+b+'" not found');return c[b]()}if(_.isFunction(b))return b;if(_.isObject(b)&&b.type){var d=b;return c[d.type](d)}throw new Error("Invalid validator: "+b)},b}(),a.validators=function(){var b={};return b.errMessages={required:"Required",regexp:"Invalid",email:"Invalid email address",url:"Invalid URL",match:'Must match field "{{field}}"'},b.required=function(b){return b=_.extend({type:"required",message:this.errMessages.required},b),function(d){b.value=d;var e={type:b.type,message:a.helpers.createTemplate(b.message,b)};if(d===null||d===undefined||d==="")return e}},b.regexp=function(b){if(!b.regexp)throw new Error('Missing required "regexp" option for "regexp" validator');return b=_.extend({type:"regexp",message:this.errMessages.regexp},b),function(d){b.value=d;var e={type:b.type,message:a.helpers.createTemplate(b.message,b)};if(d===null||d===undefined||d==="")return;if(!b.regexp.test(d))return e}},b.email=function(a){return a=_.extend({type:"email",message:this.errMessages.email,regexp:/^[\w\-]{1,}([\w\-.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/},a),b.regexp(a)},b.url=function(a){return a=_.extend({type:"url",message:this.errMessages.url,regexp:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?/i},a),b.regexp(a)},b.match=function(b){if(!b.field)throw new Error('Missing required "field" options for "match" validator');return b=_.extend({type:"match",message:this.errMessages.match},b),function(d,e){b.value=d;var f={type:b.type,message:a.helpers.createTemplate(b.message,b)};if(d===null||d===undefined||d==="")return;if(d!=e[b.field])return f}},b}(),a.Field=function(){var b=a.helpers,c=a.templates;return Backbone.View.extend({initialize:function(a){this.form=a.form,this.key=a.key,this.value=a.value,this.model=a.model;var c=this.schema=function(){return _.isString(a.schema)?{type:a.schema}:a.schema||{}}();c.type||(c.type="Text"),c.title||(c.title=b.keyToTitle(this.key)),c.template||(c.template="field")},render:function(){var c=this.schema,d=a.templates,e={form:this.form,key:this.key,schema:c,idPrefix:this.options.idPrefix,id:this.getId()};this.model?e.model=this.model:e.value=this.value;var f=this.editor=b.createEditor(c.type,e),g=$(d[c.template]({key:this.key,title:c.title,id:f.id,type:c.type,editor:'<span class="bbf-placeholder-editor"></span>',help:'<span class="bbf-placeholder-help"></span>'})),h=$(".bbf-placeholder-editor",g);return h.append(f.render().el),h.children().unwrap(),this.$help=$(".bbf-placeholder-help",g).parent(),this.$help.empty(),this.schema.help&&this.$help.html(this.schema.help),this.schema.fieldClass&&g.addClass(this.schema.fieldClass),this.schema.fieldAttrs&&g.attr(this.schema.fieldAttrs),this.setElement(g),this},getId:function(){var a=this.options.idPrefix,b=this.key;return b=b.replace(/\./g,"_"),_.isString(a)||_.isNumber(a)?a+b:_.isNull(a)?b:this.model?this.model.cid+"_"+b:b},validate:function(){var a=this.editor.validate();return a?this.setError(a.message):this.clearError(),a},setError:function(b){if(this.editor.hasNestedForm)return;var c=a.classNames.error;this.$el.addClass(c),this.$help&&this.$help.html(b)},clearError:function(){var b=a.classNames.error;this.$el.removeClass(b);if(this.$help){this.$help.empty();var c=this.schema.help;c&&this.$help.html(c)}},commit:function(){return this.editor.commit()},getValue:function(){return this.editor.getValue()},setValue:function(a){this.editor.setValue(a)},logValue:function(){if(!console||!console.log)return;console.log(this.getValue())},remove:function(){this.editor.remove(),Backbone.View.prototype.remove.call(this)}})}(),a.editors=function(){var b={};return b.Base=Backbone.View.extend({defaultValue:null,initialize:function(a){var a=a||{};if(a.model){if(!a.key)throw"Missing option: 'key'";this.model=a.model,this.key=a.key,this.value=this.model.get(this.key)}else a.value&&(this.value=a.value);this.value===undefined&&(this.value=this.defaultValue),this.form=a.form,this.schema=a.schema||{},this.validators=a.validators||this.schema.validators,this.$el.attr("name",this.getName()),this.schema.editorClass&&this.$el.addClass(this.schema.editorClass),this.schema.editorAttrs&&this.$el.attr(this.schema.editorAttrs)},getValue:function(){throw"Not implemented. Extend and override this method."},setValue:function(){throw"Not implemented. Extend and override this method."},getName:function(){var a=this.key||"";return a.replace(/\./g,"_")},commit:function(){var a=this.validate();if(a)return a;this.model.set(this.key,this.getValue(),{error:function(b,c){a=c}});if(a)return a},validate:function(){var b=this.$el,c=null,d=this.getValue(),e=this.form?this.form.getValue():{},f=this.validators,g=a.helpers.getValidator;return f&&_.each(f,function(a){c||(c=g(a)(d,e))}),c}}),b.Text=b.Base.extend({tagName:"input",defaultValue:"",initialize:function(a){b.Base.prototype.initialize.call(this,a);var c=this.schema,d="text";c&&c.editorAttrs&&c.editorAttrs.type&&(d=c.editorAttrs.type),c&&c.dataType&&(d=c.dataType),this.$el.attr("type",d)},render:function(){return this.setValue(this.value),this},getValue:function(){return this.$el.val()},setValue:function(a){this.$el.val(a)}}),b.Number=b.Text.extend({defaultValue:0,events:{keypress:"onKeyPress"},initialize:function(a){b.Text.prototype.initialize.call(this,a),this.$el.attr("type","number")},onKeyPress:function(a){if(a.charCode==0)return;var b=this.$el.val()+String.fromCharCode(a.charCode),c=/^[0-9]*\.?[0-9]*?$/.test(b);c||a.preventDefault()},getValue:function(){var a=this.$el.val();return a===""?null:parseFloat(a,10)},setValue:function(a){a=a===null?null:parseFloat(a,10),b.Text.prototype.setValue.call(this,a)}}),b.Password=b.Text.extend({initialize:function(a){b.Text.prototype.initialize.call(this,a),this.$el.attr("type","password")}}),b.TextArea=b.Text.extend({tagName:"textarea"}),b.Checkbox=b.Base.extend({defaultValue:!1,tagName:"input",initialize:function(a){b.Base.prototype.initialize.call(this,a),this.$el.attr("type","checkbox")},render:function(){return this.setValue(this.value),this},getValue:function(){return this.$el.attr("checked")?!0:!1},setValue:function(a){a&&this.$el.attr("checked",!0)}}),b.Hidden=b.Base.extend({defaultValue:"",initialize:function(a){b.Text.prototype.initialize.call(this,a),this.$el.attr("type","hidden")},getValue:function(){return this.value},setValue:function(a){this.value=a}}),b.Select=b.Base.extend({tagName:"select",initialize:function(a){b.Base.prototype.initialize.call(this,a);if(!this.schema||!this.schema.options)throw"Missing required 'schema.options'"},render:function(){var a=this.schema.options,b=this;if(a instanceof Backbone.Collection){var c=a;c.length>0?b.renderOptions(a):c.fetch({success:function(c){b.renderOptions(a)}})}else _.isFunction(a)?a(function(a){b.renderOptions(a)}):b.renderOptions(a);return this},renderOptions:function(a){var b=this.$el,c;_.isString(a)?c=a:_.isArray(a)?c=this._arrayToHtml(a):a instanceof Backbone.Collection&&(c=this._collectionToHtml(a)),b.html(c),this.setValue(this.value)},getValue:function(){return this.$el.val()},setValue:function(a){this.$el.val(a)},_collectionToHtml:function(a){var b=[];a.each(function(a){b.push({val:a.id,label:a.toString()})});var c=this._arrayToHtml(b);return c},_arrayToHtml:function(a){var b=[];return _.each(a,function(a){if(_.isObject(a)){var c=a.val?a.val:"";b.push('<option value="'+c+'">'+a.label+"</option>")}else b.push("<option>"+a+"</option>")}),b.join("")}}),b.Radio=b.Select.extend({tagName:"ul",className:"bbf-radio",getValue:function(){return this.$el.find("input[type=radio]:checked").val()},setValue:function(a){this.$el.find("input[type=radio][value="+a+"]").attr("checked",!0)},_arrayToHtml:function(a){var b=[],c=this;return _.each(a,function(a,d){var e="<li>";if(_.isObject(a)){var f=a.val?a.val:"";e+='<input type="radio" name="'+c.id+'" value="'+f+'" id="'+c.id+"-"+d+'" />',e+='<label for="'+c.id+"-"+d+'">'+a.label+"</label>"}else e+='<input type="radio" name="'+c.id+'" value="'+a+'" id="'+c.id+"-"+d+'" />',e+='<label for="'+c.id+"-"+d+'">'+a+"</label>";e+="</li>",b.push(e)}),b.join("")}}),b.Checkboxes=b.Select.extend({tagName:"ul",className:"bbf-checkboxes",getValue:function(){var a=[];return this.$el.find("input[type=checkbox]:checked").each(function(){a.push($(this).val())}),a},setValue:function(a){var b=this;_.each(a,function(a){b.$el.find('input[type=checkbox][value="'+a+'"]').attr("checked",!0)})},_arrayToHtml:function(a){var b=[],c=this;return _.each(a,function(a,d){var e="<li>";if(_.isObject(a)){var f=a.val?a.val:"";e+='<input type="checkbox" name="'+c.id+'" value="'+f+'" id="'+c.id+"-"+d+'" />',e+='<label for="'+c.id+"-"+d+'">'+a.label+"</label>"}else e+='<input type="checkbox" name="'+c.id+'" value="'+a+'" id="'+c.id+"-"+d+'" />',e+='<label for="'+c.id+"-"+d+'">'+a+"</label>";e+="</li>",b.push(e)}),b.join("")}}),b.Object=b.Base.extend({hasNestedForm:!0,className:"bbf-object",defaultValue:{},initialize:function(a){b.Base.prototype.initialize.call(this,a);if(!this.schema.subSchema)throw"Missing required 'schema.subSchema' option for Object editor"},render:function(){var b=this.$el,c=this.value||{},d=this.key,e=this.schema,f=e.subSchema;return this.form=new a({schema:f,data:c,idPrefix:this.id+"_"}),b.html(this.form.render().el),this},getValue:function(){return this.form.getValue()},setValue:function(a){this.value=a,this.render()},remove:function(){this.form.remove(),Backbone.View.prototype.remove.call(this)},validate:function(){return this.form.validate()}}),b.NestedModel=b.Object.extend({initialize:function(a){b.Base.prototype.initialize.call(this,a);if(!a.schema.model)throw'Missing required "schema.model" option for NestedModel editor'},render:function(){var b=this.value||{},c=this.key,d=this.schema.model,e=d.prototype.schema;return _.isFunction(e)&&(e=e()),this.form=new a({schema:e,model:new d(b),idPrefix:this.id+"_"}),this.$el.html(this.form.render().el),this},commit:function(){var a=this.form.commit();return a?(this.$el.addClass("error"),a):b.Object.prototype.commit.call(this)}}),b}(),a.setTemplates=a.helpers.setTemplates,a.setTemplateCompiler=a.helpers.setTemplateCompiler,a.setTemplates(b,c),a})